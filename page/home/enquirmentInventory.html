<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>设备报修</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--标准mui.css-->
		<link rel="stylesheet" href="../../css/mui.min.css">
		<link href="../../css/mui.picker.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.min.css" />
		<link rel="stylesheet" href="../../css/mui.min.css">
		<style>
			
		</style>
	</head>
	<body >
		<div class="mui-content">
			<div class="mui-content-padded" style="margin: 5px;">
				
				<form id="eqinfo" class="mui-input-group">
					<div hidden="hidden" class="mui-input-row">
						<label>所属科室:</label>
						<input id="eqks" readonly="readonly" type="text" class="mui-input .grey-input-color mui-input-clear" placeholder="">
						<input id="eqksid" readonly="readonly" type="text" hidden="hidden" name="idCustomerKs" value="" class="mui-input .grey-input-color" placeholder="">
						<input id="eqksinfo" readonly="readonly" type="text" hidden="hidden" name="idKsEqInfo" value="" class="mui-input .grey-input-color" placeholder="">

					</div>
					<div class="mui-input-row">
						<label>设备名称:</label>
						<input id="eqname" readonly="readonly" type="text" name="eqNamename" class="mui-input mui-input-clear" placeholder="">
						<input id="eqnameid" readonly="readonly" type="text" hidden="hidden" name="eqName" class="mui-input" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>设备品牌:</label>
						<input id="eqpn" readonly="readonly" type="text" name="eqBrandname" class="mui-input mui-input-clear" placeholder="">
						<input id="eqpnid" readonly="readonly" type="text" hidden="hidden" name="eqBrand" class="mui-input" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>设备型号:</label>
						<input id="eqnumber" readonly="readonly" type="text" name="eqModename" class="mui-input mui-input-clear" placeholder="">
						<input id="eqnumberid" readonly="readonly" hidden="hidden" name="eqMode" type="text" class="mui-input" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>设备序列号:</label>
						<input id="eqserialnumber" readonly="readonly" type="text" name="eqOrdername" class="mui-input mui-input-clear" placeholder="">
						<input id="eqserialnumberid" readonly="readonly" hidden="hidden" type="text" name="eqOrder" class="mui-input" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>设备资产号:</label>
						<input id="eqassetnumber" readonly="readonly" type="text" name="eqAssetCodename" class="mui-input mui-input-clear" placeholder="">
						<input id="eqassetnumberid" readonly="readonly" hidden="hidden" type="text" name="eqAssetCode" class="mui-input" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>设备状态:</label>
						<input id="eqtauts" readonly="readonly" type="text" name="eqStatusCodename" class="mui-input mui-input-clear" placeholder="">
						<input id="eqtautsid" readonly="readonly" hidden="hidden" type="text" name="eqStatusCode" class="mui-input" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>档案编码:</label>
						<input id="eqarchivescode" readonly="readonly" type="text" name="eqarChivescodename" class="mui-input mui-input-clear" placeholder="">
						<input id="eqarchivescodeid" readonly="readonly" hidden="hidden" type="text" name="eqarChivescode" class="mui-input" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>生产日期:</label>
						<input id="eqdatatime" readonly="readonly" type="text"  name="eqDataTimename" class="mui-input mui-input-clear" placeholder="">
						<input id="eqdatatimeid" readonly="readonly" hidden="hidden" type="text" name="eqDataTime" class="mui-input" placeholder="">
					</div>
					<div hidden="hidden" class="mui-input-row">
						<label>预警时间:</label>
						<input id="datatime1" readonly="readonly" type="text" class="databtn mui-input mui-input-clear" name="dtRepartWarn" placeholder="请选择预警时间">
					</div>
					<div hidden="hidden" class="mui-input-row">
						<label>报修时间:</label>
						<input id="datatime2" readonly="readonly" type="text" class="databtn mui-input mui-input-clear" name="tmRepart" placeholder="请选择报修时间">
					</div>
					<div class="mui-input-row" hidden="hidden">
						<label>盘点类型:</label>
						<input id="eqsuoshukeshi" readonly="readonly" type="text" class="mui-input" placeholder="请选择存放科室">
						<input id="eqsuoshukeshiid" readonly="readonly" name="cunFangKeShi" hidden="hidden" type="text" class="mui-input" placeholder="">
					</div>
					<div class="mui-input-row">
						<label>盘点结果:</label>
						<input id="maintentancetype" readonly="readonly" type="text" class="mui-input" placeholder="请选择盘点结果">
						<input id="maintentancetypeid" readonly="readonly" hidden="hidden" type="text" name="inventoryResult" class="mui-input" placeholder="">
					</div>
					
					<div hidden="hidden" class="mui-input-row">
						<label>申请人:</label>
						<input id="applytruename" type="text" name="reappName" class="mui-input-clear" placeholder="请输入报修申请人">
					</div>
				
				<div class="mui-input-row" style="margin: 0px 0px;">
					<label>备注:</label>
				</div>
				
				<div class="mui-input-row" style="margin: 0px 0px;">
					<textarea id="textarea" rows="5" name="inventoryInfo" placeholder=""></textarea>
				</div>
				<!--<div class="mui-button-row">
					<button type="submit" class="mui-btn mui-btn-primary" onclick="return false;" >确认</button>&nbsp;&nbsp;
					<button type="button" class="mui-btn mui-btn-danger" onclick="return false;">取消</button>
				</div>-->
				</form>
				<div class="mui-button-row">
					<button type="button" class="mui-btn mui-btn-primary" onclick="commitData()" >确认</button>&nbsp;&nbsp;
					<button type="button" class="mui-btn mui-btn-danger" onclick="canclData()">取消</button>
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../js/mui.js" ></script>
	<script type="text/javascript" src="../../js/datatime.js" ></script>
	<script src="../../js/mui.picker.js"></script>
	<script src="../../js/mui.poppicker.js"></script>
	<script src="../../js/mui.dtpicker.js"></script>
	<script type="text/javascript">
		
	</script>
	<script type="text/javascript">
		
		var jgId,keshipandianid,keshipandianleixing;
		mui.plusReady(function () {
			var self = plus.webview.currentWebview();
			var r = self.result1;
			jgId = self.CheckJg;
			keshipandianid = self.checkBm;
			keshipandianleixing = self.EqCheckType;
			
			document.getElementById("eqsuoshukeshiid").setAttribute('value',keshipandianleixing) ;
			//alert(document.getElementById("eqsuoshukeshiid").value);
			//eqsuoshukeshiid
			if(r==undefined||r ==""||r==null||r=="null"||r=="undefined"){
				var userinfo = localStorage.getItem("loginuserinfo");
				document.getElementById("applytruename").setAttribute('value',JSON.parse(userinfo).user_info.true_name);  
				var arrinput = document.getElementsByTagName('input');
				for (var i = 0; i < arrinput.length; i++) {
					arrinput[i].removeAttribute('readonly') ;
				}
			}else{
				console.log("else rrrr---->>>> "+ r);
				var arr = new Array();
				arr = r.split('id=');
				getEnquirmentInfo (arr[arr.length-1]);
			}
			var eqinventory = self.eqinventorySSS;
			var cunfangzidian1 = self.eqcufangzidian;
		 	//alert(cunfangzidian1)
			(function($, doc) {
			$.init();
			$.ready(function() {
				var userPicker = new $.PopPicker();
				userPicker.setData(JSON.parse(eqinventory));
				
					var maintentancetypeButton = doc.getElementById('maintentancetype');
					var maintentancetypeButtonid = doc.getElementById('maintentancetypeid');
					maintentancetypeButton.addEventListener('tap', function(event) {
					userPicker.show(function(items) {
						maintentancetypeButton.value = JSON.stringify(items[0].text).replace(new RegExp('"',"g"), ""); 
						maintentancetypeButtonid.setAttribute('value',JSON.stringify(items[0].value).replace(new RegExp('"',"g"), ""));
							//返回 false 可以阻止选择框的关闭
							//return false; 
						});
					}, false);	
				var cunfangPicker = new $.PopPicker();
				cunfangPicker.setData(cunfangzidian1);
				
					var eqsuoshukeshiButton = doc.getElementById('eqsuoshukeshi');
					var eqsuoshukeshiButtonid = doc.getElementById('eqsuoshukeshiid');
					eqsuoshukeshiButton.addEventListener('tap', function(event) {
					cunfangPicker.show(function(items) {
						eqsuoshukeshiButton.value = JSON.stringify(items[0].text).replace(new RegExp('"',"g"), ""); 
						eqsuoshukeshiButtonid.setAttribute('value',JSON.stringify(items[0].value).replace(new RegExp('"',"g"), ""));
							//返回 false 可以阻止选择框的关闭
							//return false; 
						});
					}, false);	
				
			});
				var btns = $('.databtn');
				btns.each(function(i, btn) {
					var id = this.getAttribute('id');
					var datatime = document.getElementById(id);
					datatime.setAttribute('value',getNowDateTime());
					btn.addEventListener('tap', function() {
						var _self = this;
						if(_self.picker) {
							_self.picker.show(function (rs) {
								_self.picker.dispose(); 
								_self.picker = null;
							});
						} else {
							var optionsJson = this.getAttribute('data-options') || '{}';
							var options = JSON.parse(optionsJson);
							var id = this.getAttribute('id');
							/*
							 * 首次显示时实例化组件
							 * 示例为了简洁，将 options 放在了按钮的 dom 上
							 * 也可以直接通过代码声明 optinos 用于实例化 DtPicker
							 */
							_self.picker = new $.DtPicker(options);
							_self.picker.show(function(rs) {
								/*
								 * rs.value 拼合后的 value
								 * rs.text 拼合后的 text
								 * rs.y 年，可以通过 rs.y.vaue 和 rs.y.text 获取值和文本
								 * rs.m 月，用法同年
								 * rs.d 日，用法同年
								 * rs.h 时，用法同年
								 * rs.i 分（minutes 的第二个字母），用法同年
								 */
								var datatime = document.getElementById(id);
								datatime.setAttribute('value',rs.value); 
								/* 
								 * 返回 false 可以阻止选择框的关闭
								 * return false;
								 */
								/*
								 * 释放组件资源，释放后将将不能再操作组件
								 * 通常情况下，不需要示放组件，new DtPicker(options) 后，可以一直使用。
								 * 当前示例，因为内容较多，如不进行资原释放，在某些设备上会较慢。
								 * 所以每次用完便立即调用 dispose 进行释放，下次用时再创建新实例。
								 */
								_self.picker.dispose();
								_self.picker = null;
							});
						}
						
					}, false);
				});
		})(mui, document);
		
		});
		function getEnquirmentInfo (eqid) {
//			http://10.131.103.128:8080/hemsApp/app/qryEqCheckMsg.do?id=ded2a754-b50f-4676-8060-791f6a4af496
				var mask = mui.createMask();//遮罩层//http://10.131.103.128:8080/HEMS/app/qryRepairEqMsg.do?id=c86f1d75-c625-496b-a43d-90db536ced5b
				var url = localStorage.getItem("url")+ "/app/qryEqCheckMsg.do?";
				
				console.log("getEnquirmentInfo---->>>> "+url);
				mui.ajax(url,{
				data:{
					id:eqid
				},
				dataType:'JSON',//服务器返回json格式数据
				type:'post',//HTTP请求类型
				timeout:15000,//超时时间设置为10秒；
				beforeSend:function(){
					 plus.nativeUI.showWaiting("加载中", {});
					 mask.show();//显示遮罩层
				},
				complete: function() {
		        plus.nativeUI.closeWaiting();
		        mask.close();//关闭遮罩层
		   		 },              
				success:function(data){  
				console.log("getEnquirmentInfo---->>>>> "+ data);
				 plus.nativeUI.closeWaiting();
		        mask.close();//关闭遮罩层
				var result = JSON.parse(data); 
				showInfo(data);
				
				},
				error:function(XMLHttpRequest, textStatus, errorThrown){
					 plus.nativeUI.closeWaiting();
		        	 mask.close();//关闭遮罩层
						//异常处理；
						console.log("requestNet error ："+XMLHttpRequest.status+"<-->"+XMLHttpRequest.readyState+"<-->"+textStatus);
						plus.nativeUI.toast("网络访问失败!");
					}
				});
			
			}
		function showInfo (datainfo) { 
			/*
			EQ_NAME,--设备名称
			EQ_NAME_ID,--设备名称ID
			EQ_BRAND, --品牌
			EQ_BRAND_ID,----品牌ID
			EQ_MODEL, --型号
			EQ_ORDER, --设备序号
			EQ_ASSET_CODE,--资产号
			EQ_STATUS --设备状态
			EQ_STATUS_ID --设备状态ID
			FILE_CODE--档案编码
			DT_PRODUCE--生产日期
			eqtauts eqarchivescode eqdatatime
			*/
			document.getElementById("eqks").value = JSON.parse(datainfo).CUSTOMER_KS;
			document.getElementById("eqname").value = JSON.parse(datainfo).EQ_NAME;
			document.getElementById("eqpn").value = JSON.parse(datainfo).EQ_BRAND;
			document.getElementById("eqnumber").value = JSON.parse(datainfo).EQ_MODEL;
			document.getElementById("eqserialnumber").value = JSON.parse(datainfo).EQ_ORDER;
			document.getElementById("eqassetnumber").value = JSON.parse(datainfo).EQ_ASSET_CODE;
			document.getElementById("eqtauts").value = JSON.parse(datainfo).EQ_STATUS_ID;
			document.getElementById("eqarchivescode").value = JSON.parse(datainfo).FILE_CODE;
			document.getElementById("eqdatatime").value = JSON.parse(datainfo).DT_PRODUCE;
			//var userinfo = localStorage.getItem("loginuserinfo");
			//document.getElementById("applytruename").setAttribute('value',JSON.parse(userinfo).user_info.true_name);  
			document.getElementById("eqksid").setAttribute('value',JSON.parse(datainfo).CUSTOMER_KS_ID);
			document.getElementById("eqksinfo").setAttribute('value',JSON.parse(datainfo).KSEQ_INFO_ID);
			document.getElementById("eqnameid").setAttribute('value', JSON.parse(datainfo).EQ_NAME_ID);
			document.getElementById("eqpnid").setAttribute('value', JSON.parse(datainfo).EQ_BRAND_ID);
			document.getElementById("eqnumberid").setAttribute('value', JSON.parse(datainfo).EQ_MODEL);
			document.getElementById("eqserialnumberid").setAttribute('value', JSON.parse(datainfo).EQ_ORDER);
			document.getElementById("eqassetnumberid").setAttribute('value', JSON.parse(datainfo).EQ_ASSET_CODE);
			document.getElementById("eqtautsid").value = JSON.parse(datainfo).EQ_STATUS_ID;
			document.getElementById("eqarchivescodeid").value = JSON.parse(datainfo).FILE_CODE;
			document.getElementById("eqdatatimeid").value = JSON.parse(datainfo).DT_PRODUCE;
		}
		
		function canclData() {
			mui.back();
		}
		
		
		function commitData() {
			var invenresult = document.getElementById("maintentancetype").value; 
			if(invenresult==''||invenresult==null||invenresult=="null"||invenresult==undefined||invenresult=='undefined'){
				alert("请输入盘点结果");
				mui.toast("请输入盘点结果");
				return;
			}else{
				
			var arr = document.getElementsByTagName("input");
			var paramsData = {};
			for( var i = 0; i < arr.length; i++){ 
				if (arr[i].getAttribute('name')!=null) {
					//paramsData[arr[i].getAttribute('name')] = arr[i].getAttribute('value');
					paramsData[arr[i].getAttribute('name')] = arr[i].value;

				}
			}
			paramsData["repartInfo"] = document.getElementById("textarea").value;
			var userinfo = localStorage.getItem("loginuserinfo");
			paramsData["sessionid"] = JSON.parse(userinfo).sessionId;
			paramsData["CheckJg"] = jgId;
			paramsData["checkBm"] = keshipandianid;
			paramsData["EqCheckType"] = keshipandianleixing;					
			console.log(JSON.stringify(paramsData));
			var mask = mui.createMask();//遮罩层//
				var url = localStorage.getItem("url")+ "/app/upEqCheckDetail.do?";
				console.log("url----->>>> "+ url);
				mui.ajax(url,{
				data:paramsData,
				dataType:'JSON',//服务器返回json格式数据
				type:'post',//HTTP请求类型
				timeout:15000,//超时时间设置为10秒；
				beforeSend:function(){
					 plus.nativeUI.showWaiting("正在保存", {});
					 mask.show();//显示遮罩层
				},
				complete: function() {
		        plus.nativeUI.closeWaiting();
		        mask.close();//关闭遮罩层
		   		 },              
				success:function(data){  
				console.log("commit---->>>>> "+ data);
				var status = JSON.parse(data).code; 
				var msg = JSON.parse(data).msg;
				switch (status){
					case "0":
						mui.toast(msg);
						break;
					case "1":
						mui.toast(msg);
						setTimeout(function () {
							//refreshInventoryEQ
							var webview = plus.webview.getWebviewById("inventorystart.html");
							mui.fire(webview,'refreshInventoryEQ',{});
							mui.back();
						},1000);
						
						break;
					case "2":
						mui.toast(msg);
						break;
					default:
						break;
				}
				
				},
				error:function(XMLHttpRequest, textStatus, errorThrown){
						//异常处理；
						console.log("requestNet error ："+XMLHttpRequest.status+"<-->"+XMLHttpRequest.readyState+"<-->" +textStatus);
						plus.nativeUI.toast("网络访问失败!");
					}
				});
		}
		}
		
	</script>
	
</html>
